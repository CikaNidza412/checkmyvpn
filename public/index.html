<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check my VPN - Uncle Nickâ€™s Network</title>
  <meta name="description" content="Check your public IP address and VPN/Proxy/Datacenter signals. Uncle Nickâ€™s Network." />

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16.png">

  <!-- Google Analytics (GA4) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1PC3L2LGFS"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-1PC3L2LGFS', { anonymize_ip: true });
  </script>

  <style>
    :root{
      color-scheme: light;
      --bg: #f6f7fb;
      --card: #ffffff;
      --shadow: 0 18px 45px rgba(0,0,0,0.08);
      --text: #1f2937;
      --muted: #6b7280;

      --drop-bg: #cfe6ff;
      --drop-border: #7cb4ff;
      --btn: #cbd5e1;
      --btn-text: #ffffff;
    }
    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 28px 18px;
    }
    .wrap{ width:min(760px,100%); display:flex; flex-direction:column; align-items:center; gap:12px; }
    .card{
      width:min(640px,100%);
      background:var(--card);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:26px 26px 18px;
    }
    .top{ display:flex; flex-direction:column; align-items:center; text-align:center; gap:10px; margin-bottom:14px; }
    .logo{
      width:74px; height:74px; border-radius:999px; background:#eef2ff;
      display:grid; place-items:center; overflow:hidden;
      border:3px solid rgba(59,130,246,0.18);
    }
    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    h1{ margin:0; font-size:22px; font-weight:500; letter-spacing:.2px; }

    .dropzone{
      margin-top:10px;
      background:var(--drop-bg);
      border:2px dashed var(--drop-border);
      border-radius:14px;
      padding:26px 18px;
      text-align:center;
    }
    .folder{ font-size:34px; line-height:1; margin-bottom:10px; }
    .drop-title{ margin:0; font-size:16px; color:rgba(37,99,235,0.75); font-weight:600; }

    .grid{ margin-top:18px; display:grid; grid-template-columns:1fr; gap:10px; text-align:left; }
    @media (min-width: 680px){ .grid{ grid-template-columns: 1fr 1fr; } }
    .item{ border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; background:#fff; }
    .label{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    .value{ font-size:14px; font-weight:600; word-break:break-word; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-weight:650; }

    .pillrow{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    .pill{
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#fff;
      padding:6px 10px;
      font-size:12px;
      font-weight:700;
    }
    .pill.bad{ border-color:#fecaca; background:#fff1f2; }
    .pill.good{ border-color:#bbf7d0; background:#f0fdf4; }

    .actions{ margin-top:14px; }
    .btn{
      width:100%;
      border:0;
      border-radius:12px;
      padding:14px 16px;
      background:var(--btn);
      color:var(--btn-text);
      font-size:15px;
      font-weight:700;
      cursor:pointer;
    }
    .mini-actions{ display:flex; gap:10px; justify-content:center; margin-top:10px; flex-wrap:wrap; }
    .linkbtn{
      border:1px solid #e5e7eb;
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      font-weight:600;
      cursor:pointer;
      color:#111827;
    }
    .status{ margin-top:10px; font-size:12px; color:var(--muted); text-align:center; }

    footer{
      width:min(640px,100%);
      text-align:center;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
      padding:6px 10px 0;
    }
    .footer-strong{ color:#374151; font-weight:600; }

    /* --- Auto refresh + IP changed UI --- */
    .ipChangeToast{
      position: fixed;
      left: 50%;
      top: 18px;
      transform: translateX(-50%) translateY(-12px);
      background: #111827;
      color: #fff;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 13px;
      font-weight: 750;
      box-shadow: 0 18px 45px rgba(0,0,0,.22);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 9999;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .ipChangeToast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    .ipChangeToast .dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 0 rgba(34,197,94,.55);
      animation: ping 1.2s ease-out 1;
    }
    @keyframes ping{
      0% { box-shadow: 0 0 0 0 rgba(34,197,94,.55); }
      100% { box-shadow: 0 0 0 14px rgba(34,197,94,0); }
    }
    .card.pulse{ animation: cardPulse .55s ease; }
    @keyframes cardPulse{
      0% { box-shadow: var(--shadow); }
      50% { box-shadow: 0 24px 70px rgba(96,165,250,.28); }
      100% { box-shadow: var(--shadow); }
    }
    .livePill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background:#fff;
      color:#111827;
      font-size:12px;
      font-weight:750;
    }
    .livePill .miniDot{
      width:8px; height:8px; border-radius:999px;
      background:#9ca3af;
    }
    .livePill.on .miniDot{ background:#22c55e; }
    .livePill .muted{ font-weight:650; color:#6b7280; }
  </style>
</head>

<body>
  <div class="ipChangeToast" id="ipToast" aria-live="polite">
    <span class="dot"></span>
    <span id="ipToastText">IP changed</span>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="logo">
          <img src="/assets/logo-checkmyvpn.png" alt="Uncle Nick logo"
               onerror="this.style.display='none'; this.parentElement.textContent='UN'; this.parentElement.style.fontWeight='900'; this.parentElement.style.color='#2563eb';">
        </div>
        <h1>Uncle Nickâ€™s Network â€” Check My VPN</h1>
        <div class="livePill" id="livePill" title="Auto-refresh checks your IP periodically.">
          <span class="miniDot"></span><span>Live</span><span class="muted" id="liveMeta">â€”</span>
        </div>
      </div>

      <div class="dropzone" aria-label="IP info panel">
        <div class="folder">ðŸ“Œ</div>
        <p class="drop-title">Your IP, location, and VPN/Proxy signals</p>

        <div class="grid">
          <div class="item">
            <div class="label">IP Address</div>
            <div class="value mono" id="ip">Loadingâ€¦</div>
          </div>

          <div class="item">
            <div class="label">Location (best effort)</div>
            <div class="value" id="loc">Loadingâ€¦</div>
          </div>

          <div class="item">
            <div class="label">ASN / ISP</div>
            <div class="value" id="asn">Loadingâ€¦</div>
          </div>

          <div class="item">
            <div class="label">VPN Verdict</div>
            <div class="value" id="verdict">Loadingâ€¦</div>
            <div class="pillrow" id="pills"></div>
          </div>

          <div class="item">
            <div class="label">Country mismatch (Cloudflare vs IP DB)</div>
            <div class="value" id="mismatch">Loadingâ€¦</div>
          </div>

          <div class="item">
            <div class="label">Data source</div>
            <div class="value" id="source">Loadingâ€¦</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="refresh">Refresh</button>
          <div class="mini-actions">
            <button class="linkbtn" id="copy">Copy IP</button>
            <button class="linkbtn" id="copyjson">Copy JSON</button>
          </div>
          <div class="status" id="status">No logs. Analytics are aggregated only.</div>
        </div>
      </div>
    </div>

    <footer>
      <div class="footer-strong">Â© 2026 Uncle Nickâ€™s Network</div>
      Privacy: No logs, no tracking (server-side). Analytics: aggregated metrics only.
    </footer>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const AUTO_REFRESH_MS = 6000; // 6000â€“15000 is a good range
  let autoTimer = null;
  let inFlight = false;
  let lastFingerprint = null;

  function pill(text, kind) {
    const el = document.createElement("span");
    el.className = `pill ${kind || ""}`.trim();
    el.textContent = text;
    return el;
  }

  function makeFingerprint(data){
    const ip = data?.ip || "";
    const loc = data?.location || "";
    const asn = data?.asn || "";
    return [ip, loc, asn].join("|");
  }

  function showToast(text){
    const toast = $("ipToast");
    const toastText = $("ipToastText");
    if (!toast || !toastText) return;

    toastText.textContent = text;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2400);
  }

  function pulseCard(){
    const card = document.querySelector(".card");
    if (!card) return;
    card.classList.remove("pulse");
    void card.offsetWidth; // restart animation
    card.classList.add("pulse");
  }

  function setLive(on, meta){
    const pillEl = $("livePill");
    const metaEl = $("liveMeta");
    if (!pillEl || !metaEl) return;
    pillEl.classList.toggle("on", !!on);
    metaEl.textContent = meta || "â€”";
  }

  async function load({ silent = false } = {}) {
    if (inFlight) return;
    inFlight = true;

    if (!silent){
      $("refresh").disabled = true;
      $("status").textContent = "Fetchingâ€¦";
      ["ip","loc","asn","verdict","mismatch","source"].forEach(k => $(k).textContent = "Loadingâ€¦");
      $("pills").innerHTML = "";
    } else {
      setLive(true, "checkingâ€¦");
    }

    try {
      const res = await fetch(`/api/ip?ts=${Date.now()}`, {
        cache: "no-store",
        headers: { "Accept": "application/json" }
      });
      if (!res.ok) throw new Error("API error: " + res.status);

      const data = await res.json();
      window.__lastJson = data;

      $("ip").textContent = data.ip || "N/A";
      $("loc").textContent = data.location || "N/A";
      $("asn").textContent = data.asn || "N/A";
      $("source").textContent = data.source || "N/A";

      const vpnLikely = !!data?.verdict?.vpnLikely;
      $("verdict").textContent = vpnLikely ? "Likely VPN / Proxy / Datacenter" : "No strong signal";

      const pillsEl = $("pills");
      pillsEl.innerHTML = "";
      const flags = data.flags || {};
      const reasons = data?.verdict?.reasons || [];

      if (vpnLikely) pillsEl.appendChild(pill("VPN check: FLAGGED", "bad"));
      else pillsEl.appendChild(pill("VPN check: OK", "good"));

      if (flags.is_vpn) pillsEl.appendChild(pill("is_vpn", "bad"));
      if (flags.is_proxy) pillsEl.appendChild(pill("is_proxy", "bad"));
      if (flags.is_tor) pillsEl.appendChild(pill("is_tor", "bad"));
      if (flags.is_datacenter) pillsEl.appendChild(pill("is_datacenter", "bad"));
      if (flags.is_abuser) pillsEl.appendChild(pill("is_abuser", "bad"));

      if (!flags.is_vpn && !flags.is_proxy && !flags.is_tor && !flags.is_datacenter && !flags.is_abuser) {
        pillsEl.appendChild(pill("no flags", "good"));
      }

      $("mismatch").textContent = data.countryMismatch
        ? `${data.countryMismatch.cloudflareCountry} vs ${data.countryMismatch.ipapiCountry}`
        : "No mismatch detected";

      $("status").textContent = `Updated. Reasons: ${reasons.join(", ")}`;

      const fp = makeFingerprint(data);
      if (lastFingerprint === null){
        lastFingerprint = fp;
      } else if (fp !== lastFingerprint){
        lastFingerprint = fp;
        const newIp = data.ip || "unknown";
        const newLoc = data.location || "unknown location";
        showToast(`IP changed: ${newIp} â€¢ ${newLoc}`);
        pulseCard();
      }

      setLive(true, `every ${Math.round(AUTO_REFRESH_MS/1000)}s`);

    } catch (e) {
      console.error(e);
      $("status").textContent = "Failed to load. Try again.";
      window.__lastJson = null;
      setLive(false, "offline");
    } finally {
      $("refresh").disabled = false;
      inFlight = false;
    }
  }

  function startAuto(){
    if (autoTimer) clearInterval(autoTimer);
    load({ silent: true });
    autoTimer = setInterval(() => load({ silent: true }), AUTO_REFRESH_MS);
  }

  $("refresh").addEventListener("click", () => load({ silent: false }));

  $("copy").addEventListener("click", async () => {
    const ip = $("ip").textContent.trim();
    if (!ip || ip === "Loadingâ€¦" || ip === "N/A") return;
    try {
      await navigator.clipboard.writeText(ip);
      $("status").textContent = "IP copied âœ…";
      setTimeout(() => $("status").textContent = "Updated.", 1200);
    } catch {
      alert("Copy failed. Select and copy manually.");
    }
  });

  $("copyjson").addEventListener("click", async () => {
    if (!window.__lastJson) return;
    try {
      await navigator.clipboard.writeText(JSON.stringify(window.__lastJson, null, 2));
      $("status").textContent = "JSON copied âœ…";
      setTimeout(() => $("status").textContent = "Updated.", 1200);
    } catch {
      alert("Copy failed.");
    }
  });

  document.addEventListener("visibilitychange", () => {
    if (!document.hidden) load({ silent: true });
  });

  load({ silent: false });
  startAuto();
</script>
</body>
</html>
